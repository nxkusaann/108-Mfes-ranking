<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>文化祭ランキング</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    // Firebase SDK 読み込み
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    // あなたの Firebase 設定（固定）
    const firebaseConfig = {
      apiKey: "AIzaSyDSO0dLH3mDFQYd-srhs7crW-2nJQU3NU0",
      authDomain: "mfes-ranking.firebaseapp.com",
      projectId: "mfes-ranking",
      storageBucket: "mfes-ranking.firebasestorage.app",
      messagingSenderId: "312704030870",
      appId: "1:312704030870:web:fcafc7477eb1ff84e00ab7",
      measurementId: "G-Z0FN5HHH54"
    };

    // Firebase 初期化
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // 匿名ログイン
    signInAnonymously(auth).catch((error) => {
      console.error("認証エラー:", error);
    });

    // UI 要素
    const form = document.getElementById("scoreForm");
    const nicknameInput = document.getElementById("nickname");
    const pointsInput = document.getElementById("points");
    const messageBox = document.getElementById("message");
    const rankingList = document.getElementById("ranking");

    const adminSection = document.getElementById("adminSection");
    const adminPasswordInput = document.getElementById("adminPassword");
    const adminLoginBtn = document.getElementById("adminLogin");
    const adminList = document.getElementById("adminRanking");
    const adminLogoutBtn = document.getElementById("adminLogout");

    // 管理者パスワード（ここを変える）
    const ADMIN_PASSWORD = "108";
    let isAdmin = false;

    // --- 送信処理 ---
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nickname = nicknameInput.value.trim();
      const points = parseInt(pointsInput.value, 10);

      if (!nickname || isNaN(points)) {
        messageBox.textContent = "⚠️ ニックネームとポイントを入力してください";
        messageBox.className = "text-red-500 text-center mt-2";
        return;
      }

      try {
        await addDoc(collection(db, "leaderboard"), {
          nickname,
          points,
          createdAt: new Date()
        });
        messageBox.textContent = "✅ 送信が完了しました！";
        messageBox.className = "text-green-600 text-center mt-2";

        nicknameInput.value = "";
        pointsInput.value = "";
      } catch (error) {
        console.error("送信エラー:", error);
        messageBox.textContent = "⚠️ エラーが発生しました";
        messageBox.className = "text-red-500 text-center mt-2";
      }
    });

    // --- ランキング表示（リアルタイム） ---
    const q = query(collection(db, "leaderboard"), orderBy("points", "desc"), limit(20));
    onSnapshot(q, (snapshot) => {
      rankingList.innerHTML = "";
      adminList.innerHTML = "";

      let rank = 1;
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();

        // 通常ランキング
        const li = document.createElement("li");
        li.textContent = `${rank}. ${data.nickname} - ${data.points} 点`;
        li.className = "p-2 border-b";
        rankingList.appendChild(li);

        // 管理者用リスト（削除ボタン付き）
        const adminLi = document.createElement("li");
        adminLi.className = "p-2 flex justify-between items-center border-b";
        adminLi.innerHTML = `
          <span>${rank}. ${data.nickname} - ${data.points} 点</span>
          <button class="bg-red-500 text-white px-2 py-1 rounded text-sm">削除</button>
        `;
        const deleteBtn = adminLi.querySelector("button");
        deleteBtn.addEventListener("click", async () => {
          if (confirm(`「${data.nickname}」を削除しますか？`)) {
            await deleteDoc(doc(db, "leaderboard", docSnap.id));
          }
        });
        adminList.appendChild(adminLi);

        rank++;
      });
    });

    // --- 管理者ログイン ---
    adminLoginBtn.addEventListener("click", () => {
      if (adminPasswordInput.value === ADMIN_PASSWORD) {
        isAdmin = true;
        adminSection.classList.remove("hidden");
        adminPasswordInput.value = "";
        messageBox.textContent = "🔑 管理者ログイン成功";
        messageBox.className = "text-blue-600 text-center mt-2";
      } else {
        messageBox.textContent = "❌ パスワードが違います";
        messageBox.className = "text-red-500 text-center mt-2";
      }
    });

    // --- 管理者ログアウト ---
    adminLogoutBtn.addEventListener("click", () => {
      isAdmin = false;
      adminSection.classList.add("hidden");
      messageBox.textContent = "🚪 ログアウトしました";
      messageBox.className = "text-gray-600 text-center mt-2";
    });
  </script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-md mx-auto bg-white rounded shadow p-4">
    <h1 class="text-xl font-bold mb-4 text-center">🎉 文化祭ランキング 🎉</h1>

    <!-- 入力フォーム -->
    <form id="scoreForm" class="space-y-2">
      <input id="nickname" type="text" placeholder="ニックネーム" class="w-full border p-2 rounded" />
      <input id="points" type="number" placeholder="ポイント" class="w-full border p-2 rounded" />
      <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded">送信</button>
    </form>
    <p id="message" class="text-center mt-2"></p>

    <!-- ランキング -->
    <h2 class="text-lg font-semibold mt-6">🏆 ランキング（TOP20）</h2>
    <ul id="ranking" class="mt-2 divide-y"></ul>

    <!-- 管理者ログイン -->
    <div class="mt-6">
      <input id="adminPassword" type="password" placeholder="管理者パスワード" class="w-full border p-2 rounded" />
      <button id="adminLogin" class="w-full bg-gray-700 text-white py-2 rounded mt-2">管理者ログイン</button>
    </div>

    <!-- 管理者ページ -->
    <div id="adminSection" class="hidden mt-6">
      <div class="flex justify-between items-center">
        <h2 class="text-lg font-semibold">🔧 管理者ページ</h2>
        <button id="adminLogout" class="bg-gray-500 text-white px-2 py-1 rounded">ログアウト</button>
      </div>
      <ul id="adminRanking" class="mt-2 divide-y"></ul>
    </div>
  </div>
</body>
</html>

