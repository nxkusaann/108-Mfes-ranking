<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ–‡åŒ–ç¥­ã‚¯ãƒ©ã‚¹ä¼ç”»ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div id="message-container"></div>

<div class="container max-w-lg w-full p-6">
  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ -->
  <div id="user-view" class="space-y-6">
    <div class="bg-white rounded-xl shadow-lg p-6">
      <h1 class="text-2xl font-bold text-center">ã‚¯ãƒ©ã‚¹ä¼ç”»ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>
      <p class="text-center text-gray-600">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨ãƒã‚¤ãƒ³ãƒˆã‚’å…¥ã‚Œã¦å‚åŠ ï¼</p>
    </div>

    <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="bg-gray-50 p-6 rounded-xl shadow-inner space-y-4">
      <div>
        <label class="block text-sm font-medium">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
        <input type="text" id="nickname-input" class="w-full px-3 py-2 border rounded-md" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ "/>
      </div>
      <div>
        <label class="block text-sm font-medium">ãƒã‚¤ãƒ³ãƒˆ</label>
        <input type="number" id="points-input" class="w-full px-3 py-2 border rounded-md" value="0"/>
      </div>
      <button id="submit-button" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">é€ä¿¡</button>
    </div>

    <!-- è‡ªåˆ†ã®é †ä½ -->
    <div id="user-info" class="bg-indigo-50 p-4 rounded-lg text-center hidden">
      <p class="font-bold text-indigo-700">ã‚ãªãŸã®æƒ…å ±</p>
      <p>ID: <span id="user-id"></span></p>
      <p class="text-lg font-bold mt-2">é †ä½: <span id="user-rank"></span></p>
    </div>

    <!-- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ -->
    <div id="admin-login-section" class="bg-gray-200 p-6 rounded-xl shadow-inner space-y-4">
      <h2 class="text-lg font-bold text-center">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <input type="password" id="admin-password" class="w-full px-3 py-2 border rounded-md" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"/>
      <button id="admin-login-button" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-xl font-bold text-center mb-3">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
      <ul id="leaderboard-list" class="space-y-2"></ul>
    </div>
  </div>

  <!-- ç®¡ç†è€…ç”»é¢ -->
  <div id="admin-view" class="space-y-6 hidden">
    <div class="flex justify-between items-center">
      <h1 class="text-2xl font-bold">ç®¡ç†è€…ãƒšãƒ¼ã‚¸</h1>
      <button id="admin-logout-button" class="bg-indigo-600 text-white px-3 py-1 rounded-lg">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-xl font-bold text-center mb-3">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç®¡ç†</h2>
      <ul id="admin-leaderboard-list" class="space-y-2"></ul>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, collection, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // ğŸ”§ Firebase è¨­å®šã‚’ã“ã“ã«æ›¸ãæ›ãˆã¦ãã ã•ã„
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let userId = null;
  let isAdmin = false;
  const ADMIN_PASSWORD = "108"; // ğŸ‘ˆ ä»»æ„ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«å¤‰æ›´

  // DOM
  const userView = document.getElementById('user-view');
  const adminView = document.getElementById('admin-view');
  const nicknameInput = document.getElementById('nickname-input');
  const pointsInput = document.getElementById('points-input');
  const submitButton = document.getElementById('submit-button');
  const leaderboardList = document.getElementById('leaderboard-list');
  const adminLeaderboardList = document.getElementById('admin-leaderboard-list');
  const userInfo = document.getElementById('user-info');
  const userIdDisplay = document.getElementById('user-id');
  const userRankDisplay = document.getElementById('user-rank');
  const adminPasswordInput = document.getElementById('admin-password');
  const adminLoginButton = document.getElementById('admin-login-button');
  const adminLogoutButton = document.getElementById('admin-logout-button');

  // Firebase Auth
  onAuthStateChanged(auth, (user) => {
    if (user) {
      userId = user.uid;
      userIdDisplay.textContent = userId;
      userInfo.classList.remove("hidden");
    }
  });
  signInAnonymously(auth);

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç›£è¦–
  const q = query(collection(db, "leaderboard"));
  onSnapshot(q, (snapshot) => {
    const data = [];
    snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
    data.sort((a, b) => b.points - a.points);
    renderLeaderboard(data);
  });

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡
  submitButton.addEventListener("click", async () => {
    const nickname = nicknameInput.value.trim();
    const points = parseInt(pointsInput.value, 10);
    if (!nickname || isNaN(points)) return alert("æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
    await setDoc(doc(db, "leaderboard", userId), { nickname, points });
  });

  // ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³
  adminLoginButton.addEventListener("click", () => {
    if (adminPasswordInput.value === ADMIN_PASSWORD) {
      isAdmin = true;
      userView.classList.add("hidden");
      adminView.classList.remove("hidden");
    } else {
      alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
    }
  });

  adminLogoutButton.addEventListener("click", () => {
    isAdmin = false;
    adminView.classList.add("hidden");
    userView.classList.remove("hidden");
  });

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
  function renderLeaderboard(data) {
    leaderboardList.innerHTML = "";
    adminLeaderboardList.innerHTML = "";

    data.forEach((entry, i) => {
      const li = document.createElement("li");
      li.className = "flex justify-between bg-gray-50 p-2 rounded";
      li.innerHTML = `<span>${i + 1}. ${entry.nickname}</span><span>${entry.points}pt</span>`;
      leaderboardList.appendChild(li);

      if (isAdmin) {
        const adminLi = li.cloneNode(true);
        const delBtn = document.createElement("button");
        delBtn.textContent = "å‰Šé™¤";
        delBtn.className = "ml-2 px-2 py-1 bg-red-500 text-white rounded";
        delBtn.onclick = () => deleteDoc(doc(db, "leaderboard", entry.id));
        adminLi.appendChild(delBtn);
        adminLeaderboardList.appendChild(adminLi);
      }

      if (entry.id === userId) {
        userRankDisplay.textContent = `${i + 1}ä½`;
      }
    });
  }
</script>
</body>
</html>
