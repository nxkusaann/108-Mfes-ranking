<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>文化祭クラス企画ランキング</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div id="message-container"></div>

<div class="container max-w-lg w-full p-6">
  <!-- ユーザー画面 -->
  <div id="user-view" class="space-y-6">
    <div class="bg-white rounded-xl shadow-lg p-6">
      <h1 class="text-2xl font-bold text-center">クラス企画ランキング</h1>
      <p class="text-center text-gray-600">ニックネームとポイントを入れて参加！</p>
    </div>

    <!-- 入力フォーム -->
    <div class="bg-gray-50 p-6 rounded-xl shadow-inner space-y-4">
      <div>
        <label class="block text-sm font-medium">ニックネーム</label>
        <input type="text" id="nickname-input" class="w-full px-3 py-2 border rounded-md" placeholder="ニックネーム"/>
      </div>
      <div>
        <label class="block text-sm font-medium">ポイント</label>
        <input type="number" id="points-input" class="w-full px-3 py-2 border rounded-md" value="0"/>
      </div>
      <button id="submit-button" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">送信</button>
    </div>

    <!-- 自分の順位 -->
    <div id="user-info" class="bg-indigo-50 p-4 rounded-lg text-center hidden">
      <p class="font-bold text-indigo-700">あなたの情報</p>
      <p>ID: <span id="user-id"></span></p>
      <p class="text-lg font-bold mt-2">順位: <span id="user-rank"></span></p>
    </div>

    <!-- 管理者ログイン -->
    <div id="admin-login-section" class="bg-gray-200 p-6 rounded-xl shadow-inner space-y-4">
      <h2 class="text-lg font-bold text-center">管理者ログイン</h2>
      <input type="password" id="admin-password" class="w-full px-3 py-2 border rounded-md" placeholder="パスワード"/>
      <button id="admin-login-button" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">ログイン</button>
    </div>

    <!-- ランキング -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-xl font-bold text-center mb-3">ランキング</h2>
      <ul id="leaderboard-list" class="space-y-2"></ul>
    </div>
  </div>

  <!-- 管理者画面 -->
  <div id="admin-view" class="space-y-6 hidden">
    <div class="flex justify-between items-center">
      <h1 class="text-2xl font-bold">管理者ページ</h1>
      <button id="admin-logout-button" class="bg-indigo-600 text-white px-3 py-1 rounded-lg">ログアウト</button>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-xl font-bold text-center mb-3">ランキング管理</h2>
      <ul id="admin-leaderboard-list" class="space-y-2"></ul>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, collection, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // 🔧 Firebase 設定をここに書き換えてください
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let userId = null;
  let isAdmin = false;
  const ADMIN_PASSWORD = "108"; // 👈 任意のパスワードに変更

  // DOM
  const userView = document.getElementById('user-view');
  const adminView = document.getElementById('admin-view');
  const nicknameInput = document.getElementById('nickname-input');
  const pointsInput = document.getElementById('points-input');
  const submitButton = document.getElementById('submit-button');
  const leaderboardList = document.getElementById('leaderboard-list');
  const adminLeaderboardList = document.getElementById('admin-leaderboard-list');
  const userInfo = document.getElementById('user-info');
  const userIdDisplay = document.getElementById('user-id');
  const userRankDisplay = document.getElementById('user-rank');
  const adminPasswordInput = document.getElementById('admin-password');
  const adminLoginButton = document.getElementById('admin-login-button');
  const adminLogoutButton = document.getElementById('admin-logout-button');

  // Firebase Auth
  onAuthStateChanged(auth, (user) => {
    if (user) {
      userId = user.uid;
      userIdDisplay.textContent = userId;
      userInfo.classList.remove("hidden");
    }
  });
  signInAnonymously(auth);

  // ランキング監視
  const q = query(collection(db, "leaderboard"));
  onSnapshot(q, (snapshot) => {
    const data = [];
    snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
    data.sort((a, b) => b.points - a.points);
    renderLeaderboard(data);
  });

  // ランキング送信
  submitButton.addEventListener("click", async () => {
    const nickname = nicknameInput.value.trim();
    const points = parseInt(pointsInput.value, 10);
    if (!nickname || isNaN(points)) return alert("正しく入力してください");
    await setDoc(doc(db, "leaderboard", userId), { nickname, points });
  });

  // 管理者ログイン
  adminLoginButton.addEventListener("click", () => {
    if (adminPasswordInput.value === ADMIN_PASSWORD) {
      isAdmin = true;
      userView.classList.add("hidden");
      adminView.classList.remove("hidden");
    } else {
      alert("パスワードが違います");
    }
  });

  adminLogoutButton.addEventListener("click", () => {
    isAdmin = false;
    adminView.classList.add("hidden");
    userView.classList.remove("hidden");
  });

  // ランキング表示
  function renderLeaderboard(data) {
    leaderboardList.innerHTML = "";
    adminLeaderboardList.innerHTML = "";

    data.forEach((entry, i) => {
      const li = document.createElement("li");
      li.className = "flex justify-between bg-gray-50 p-2 rounded";
      li.innerHTML = `<span>${i + 1}. ${entry.nickname}</span><span>${entry.points}pt</span>`;
      leaderboardList.appendChild(li);

      if (isAdmin) {
        const adminLi = li.cloneNode(true);
        const delBtn = document.createElement("button");
        delBtn.textContent = "削除";
        delBtn.className = "ml-2 px-2 py-1 bg-red-500 text-white rounded";
        delBtn.onclick = () => deleteDoc(doc(db, "leaderboard", entry.id));
        adminLi.appendChild(delBtn);
        adminLeaderboardList.appendChild(adminLi);
      }

      if (entry.id === userId) {
        userRankDisplay.textContent = `${i + 1}位`;
      }
    });
  }
</script>
</body>
</html>
