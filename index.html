<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ–‡åŒ–ç¥­ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    // Firebase SDK èª­ã¿è¾¼ã¿
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    // ã‚ãªãŸã® Firebase è¨­å®šï¼ˆå›ºå®šï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyDSO0dLH3mDFQYd-srhs7crW-2nJQU3NU0",
      authDomain: "mfes-ranking.firebaseapp.com",
      projectId: "mfes-ranking",
      storageBucket: "mfes-ranking.firebasestorage.app",
      messagingSenderId: "312704030870",
      appId: "1:312704030870:web:fcafc7477eb1ff84e00ab7",
      measurementId: "G-Z0FN5HHH54"
    };

    // Firebase åˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // åŒ¿åãƒ­ã‚°ã‚¤ãƒ³
    signInAnonymously(auth).catch((error) => {
      console.error("èªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
    });

    // UI è¦ç´ 
    const form = document.getElementById("scoreForm");
    const nicknameInput = document.getElementById("nickname");
    const pointsInput = document.getElementById("points");
    const messageBox = document.getElementById("message");
    const rankingList = document.getElementById("ranking");

    const adminSection = document.getElementById("adminSection");
    const adminPasswordInput = document.getElementById("adminPassword");
    const adminLoginBtn = document.getElementById("adminLogin");
    const adminList = document.getElementById("adminRanking");
    const adminLogoutBtn = document.getElementById("adminLogout");

    // ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆã“ã“ã‚’å¤‰ãˆã‚‹ï¼‰
    const ADMIN_PASSWORD = "108";
    let isAdmin = false;

    // --- é€ä¿¡å‡¦ç† ---
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nickname = nicknameInput.value.trim();
      const points = parseInt(pointsInput.value, 10);

      if (!nickname || isNaN(points)) {
        messageBox.textContent = "âš ï¸ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨ãƒã‚¤ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        messageBox.className = "text-red-500 text-center mt-2";
        return;
      }

      try {
        await addDoc(collection(db, "leaderboard"), {
          nickname,
          points,
          createdAt: new Date()
        });
        messageBox.textContent = "âœ… é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼";
        messageBox.className = "text-green-600 text-center mt-2";

        nicknameInput.value = "";
        pointsInput.value = "";
      } catch (error) {
        console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
        messageBox.textContent = "âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
        messageBox.className = "text-red-500 text-center mt-2";
      }
    });

    // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰ ---
    const q = query(collection(db, "leaderboard"), orderBy("points", "desc"), limit(20));
    onSnapshot(q, (snapshot) => {
      rankingList.innerHTML = "";
      adminList.innerHTML = "";

      let rank = 1;
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();

        // é€šå¸¸ãƒ©ãƒ³ã‚­ãƒ³ã‚°
        const li = document.createElement("li");
        li.textContent = `${rank}. ${data.nickname} - ${data.points} ç‚¹`;
        li.className = "p-2 border-b";
        rankingList.appendChild(li);

        // ç®¡ç†è€…ç”¨ãƒªã‚¹ãƒˆï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ä»˜ãï¼‰
        const adminLi = document.createElement("li");
        adminLi.className = "p-2 flex justify-between items-center border-b";
        adminLi.innerHTML = `
          <span>${rank}. ${data.nickname} - ${data.points} ç‚¹</span>
          <button class="bg-red-500 text-white px-2 py-1 rounded text-sm">å‰Šé™¤</button>
        `;
        const deleteBtn = adminLi.querySelector("button");
        deleteBtn.addEventListener("click", async () => {
          if (confirm(`ã€Œ${data.nickname}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            await deleteDoc(doc(db, "leaderboard", docSnap.id));
          }
        });
        adminList.appendChild(adminLi);

        rank++;
      });
    });

    // --- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ ---
    adminLoginBtn.addEventListener("click", () => {
      if (adminPasswordInput.value === ADMIN_PASSWORD) {
        isAdmin = true;
        adminSection.classList.remove("hidden");
        adminPasswordInput.value = "";
        messageBox.textContent = "ğŸ”‘ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ";
        messageBox.className = "text-blue-600 text-center mt-2";
      } else {
        messageBox.textContent = "âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
        messageBox.className = "text-red-500 text-center mt-2";
      }
    });

    // --- ç®¡ç†è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ---
    adminLogoutBtn.addEventListener("click", () => {
      isAdmin = false;
      adminSection.classList.add("hidden");
      messageBox.textContent = "ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ";
      messageBox.className = "text-gray-600 text-center mt-2";
    });
  </script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-md mx-auto bg-white rounded shadow p-4">
    <h1 class="text-xl font-bold mb-4 text-center">ğŸ‰ æ–‡åŒ–ç¥­ãƒ©ãƒ³ã‚­ãƒ³ã‚° ğŸ‰</h1>

    <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <form id="scoreForm" class="space-y-2">
      <input id="nickname" type="text" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " class="w-full border p-2 rounded" />
      <input id="points" type="number" placeholder="ãƒã‚¤ãƒ³ãƒˆ" class="w-full border p-2 rounded" />
      <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded">é€ä¿¡</button>
    </form>
    <p id="message" class="text-center mt-2"></p>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
    <h2 class="text-lg font-semibold mt-6">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆTOP20ï¼‰</h2>
    <ul id="ranking" class="mt-2 divide-y"></ul>

    <!-- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ -->
    <div class="mt-6">
      <input id="adminPassword" type="password" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="w-full border p-2 rounded" />
      <button id="adminLogin" class="w-full bg-gray-700 text-white py-2 rounded mt-2">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <!-- ç®¡ç†è€…ãƒšãƒ¼ã‚¸ -->
    <div id="adminSection" class="hidden mt-6">
      <div class="flex justify-between items-center">
        <h2 class="text-lg font-semibold">ğŸ”§ ç®¡ç†è€…ãƒšãƒ¼ã‚¸</h2>
        <button id="adminLogout" class="bg-gray-500 text-white px-2 py-1 rounded">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <ul id="adminRanking" class="mt-2 divide-y"></ul>
    </div>
  </div>
</body>
</html>

